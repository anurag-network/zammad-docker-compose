server {
  listen 80;
  server_name supportticket.pansophictech.com;

  location /allyra-text-logo.png {
    alias /var/www/allyra-text-logo.png;
    expires 30d;
    add_header Cache-Control "public, immutable";
  }

  location /allyra-logo.png {
    alias /var/www/allyra-logo.png;
    expires 30d;
    add_header Cache-Control "public, immutable";
  }

  location /zammad-theme.css {
    alias /var/www/zammad-theme.css;
    add_header Cache-Control "no-cache";
    add_header Content-Type "text/css";
  }

  location /custom-zammad.js {
    alias /var/www/custom-zammad.js;
    add_header Cache-Control "no-cache";
    add_header Content-Type "application/javascript";
  }

  location /dashboard/ {
    proxy_pass http://127.0.0.1:3001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  location = /dashboard {
    return 301 /dashboard/;
  }

  location /zammad-api/ {
    proxy_pass http://127.0.0.1:3001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  location / {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port 443;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 300;
    proxy_connect_timeout 300;
    proxy_redirect off;

    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";

    proxy_hide_header Content-Security-Policy;
    proxy_set_header Accept-Encoding "";
    sub_filter "</head>" "<link rel=\"stylesheet\" href=\"/zammad-theme.css\"><script>!function(){if(navigator.serviceWorker)navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(g){g.unregister()})});var h=location.hash;if(!h||h===\"#\"||h===\"#dashboard\")location.replace(\"/dashboard/\");window.addEventListener(\"hashchange\",function(){var c=location.hash;if(!c||c===\"#\"||c===\"#dashboard\")location.replace(\"/dashboard/\")})}()</script><script src=\"/custom-zammad.js\"></script></head>";
    sub_filter_once on;
  }
}
